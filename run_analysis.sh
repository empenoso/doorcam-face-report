#!/bin/bash

# üöÄ –°–∫—Ä–∏–ø—Ç-–ª–∞—É–Ω—á–µ—Ä –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ –ø–æ –∞–Ω–∞–ª–∏–∑—É –≤–∏–¥–µ–æ üöÄ
#
# –≠—Ç–æ—Ç Shell-—Å–∫—Ä–∏–ø—Ç —É–ø—Ä–æ—â–∞–µ—Ç –∑–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ Python-—Å–∫—Ä–∏–ø—Ç–∞ face_report.py,
# –∞–∫—Ç–∏–≤–∏—Ä—É—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è
# —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ª–∏—Ü.
#
# –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –í–µ—Å—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —è–≤–ª—è–µ—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω
# –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–∞—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
#
# –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:
# - –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ Python-–æ–∫—Ä—É–∂–µ–Ω–∏—è (.venv), —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–æ–º setup_env.sh.
# - –ó–∞–ø—É—Å–∫ face_report.py —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–ø—É—Ç—å –∫ –≤–∏–¥–µ–æ, –º–æ–¥–µ–ª—å –∏ —Ç.–¥.).
# - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö "—Å—Ç—Ä–∞—Ç–µ–≥–∏–π" –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É
#   —Ä–µ–∂–∏–º–∞–º–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–±—ã—Å—Ç—Ä—ã–π HOG vs. —Ç–æ—á–Ω—ã–π CNN –Ω–∞ GPU).
# - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ –æ—Ç—á–µ—Ç–∞.
#
# –ü–æ—Ä—è–¥–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
# 1. –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –∑–∞–ø—É—Å—Ç–∏–≤ setup_env.sh.
# 2. –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –≤–∞—à–∏–º –≤–∏–¥–µ–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π INPUT_VIDEO_DIR.
# 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç.

#  –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—É: $ watch -n 10 -c --no-wrap nvidia-smi
#
# –ê–≤—Ç–æ—Ä: –ú–∏—Ö–∞–∏–ª –®–∞—Ä–¥–∏–Ω https://shardin.name/
# –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 19.08.2025
# –í–µ—Ä—Å–∏—è: 1.0
#
# –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –≤—Å–µ–≥–¥–∞ –∑–¥–µ—Å—å: https://github.com/empenoso/doorcam-face-report/
#

set -e

INPUT_VIDEO_DIR="/home/mike/–í–∏–¥–µ–æ/perm_domofon" # . –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –≤–∏–¥–µ–æ
OUTPUT_HTML_FILE="face_report_perm_domofon.html"

VENV_DIR=".venv"

echo "=== –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ ==="

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è ---
if [ ! -d "$VENV_DIR" ]; then
    echo -e "\033[1;31m[ERROR] –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ '$VENV_DIR' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏ setup_env.sh.\033[0m"
    exit 1
fi

echo "[INFO] –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
source "$VENV_DIR/bin/activate"

echo -e "\n[INFO] –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞..."

# –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –Ω–∏–∂–µ, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–≤ –Ω—É–∂–Ω—É—é —Å—Ç—Ä–æ–∫—É
#
# --- –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –¢–æ—á–Ω–∞—è –º–æ–¥–µ–ª—å CNN (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—á–∞–ª–∞) ---
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—É—é, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å CNN. –ú–∞—Å—à—Ç–∞–± –Ω–µ –º–µ–Ω—è–µ–º (1.0), —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–µ—Ç–∞–ª–∏.
# –ü—Ä–æ–ø—É—Å–∫ –∫–∞–¥—Ä–æ–≤ —É–º–µ–Ω—å—à–µ–Ω –¥–æ 15 –¥–ª—è –±–æ–ª—å—à–µ–≥–æ —à–∞–Ω—Å–∞ –ø–æ–π–º–∞—Ç—å –ª–∏—Ü–æ.
# --debug –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.
echo "[STRATEGY] –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—É—é –º–æ–¥–µ–ª—å CNN –±–µ–∑ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –æ—Ç–ª–∞–¥–∫–æ–π."
python3 face_report.py \
    --input-dir "$INPUT_VIDEO_DIR" \
    --output-html "$OUTPUT_HTML_FILE" \
    --model cnn \
    --scale 1.0 \
    --skip-frames 1 \
#    --debug

# # --- –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –ë–æ–ª–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è HOG (–µ—Å–ª–∏ CNN —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ) ---
# # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å HOG, –Ω–æ –±–µ–∑ —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–∞–¥—Ä–∞.
# echo "[STRATEGY] –ò—Å–ø–æ–ª—å–∑—É–µ–º –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å HOG –±–µ–∑ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è."
# python3 face_report.py \
#     --input-dir "$INPUT_VIDEO_DIR" \
#     --output-html "$OUTPUT_HTML_FILE" \
#     --model hog \
#     --scale 1.0 \
#     --skip-frames 15 \
#     --debug

# # --- –°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: –ò—Å—Ö–æ–¥–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è) ---
# echo "[STRATEGY] –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (hog, scale 0.5)."
# python3 face_report.py \
#     --input-dir "$INPUT_VIDEO_DIR" \
#     --output-html "$OUTPUT_HTML_FILE" \
#     --model hog \
#     --scale 0.5 \
#     --skip-frames 25 \
#     --debug

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ===
if [ -s "$OUTPUT_HTML_FILE" ]; then
    echo -e "\n\033[1;32m[SUCCESS] –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –û—Ç–∫—Ä–æ–π '$OUTPUT_HTML_FILE' –≤ –±—Ä–∞—É–∑–µ—Ä–µ.\033[0m"
else
    echo -e "\n\033[1;31m[ERROR] –§–∞–π–ª '$OUTPUT_HTML_FILE' –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω.\033[0m"
    exit 1
fi