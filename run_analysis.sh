#!/bin/bash

# üöÄ –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ üöÄ
#
# –≠—Ç–æ—Ç Shell-—Å–∫—Ä–∏–ø—Ç —è–≤–ª—è–µ—Ç—Å—è "–∫–Ω–æ–ø–∫–æ–π –∑–∞–ø—É—Å–∫–∞" –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞. –û–Ω –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ
# –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–µ Python-–æ–∫—Ä—É–∂–µ–Ω–∏–µ (—Å–æ–∑–¥–∞–Ω–Ω–æ–µ setup_env.sh) –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
# –∞–Ω–∞–ª–∏–∑–∞ face_report.py —Å –Ω—É–∂–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏. –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, –∏–∑–±–∞–≤–ª—è—è –æ—Ç
# –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é –≤–≤–æ–¥–∏—Ç—å –¥–ª–∏–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ.
#
# –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
# - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π –∫ –ø–∞–ø–∫–µ —Å –≤–∏–¥–µ–æ—Ñ–∞–π–ª–∞–º–∏ –∏ –∫ –∏—Ç–æ–≥–æ–≤–æ–º—É HTML-–æ—Ç—á–µ—Ç—É
# - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≥–æ—Ç–æ–≤–æ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è, —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–æ–º setup_env.sh
# - –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ Python-–æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
# - –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ Python-—Å–∫—Ä–∏–ø—Ç–∞ (face_report.py) —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
# - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≥–æ—Ç–æ–≤—ã—Ö "—Å—Ç—Ä–∞—Ç–µ–≥–∏–π" –∑–∞–ø—É—Å–∫–∞ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ –∫–æ–¥–µ),
#   –ø–æ–∑–≤–æ–ª—è—é—â–∏—Ö –ª–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –±—ã—Å—Ç—Ä–æ–π –º–æ–¥–µ–ª—å—é (HOG) –∏ —Ç–æ—á–Ω–æ–π (CNN)
# - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –æ—Ç—á–µ—Ç–∞
#
# –ü–æ—Ä—è–¥–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: –°–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å setup_env.sh –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
# –ó–∞—Ç–µ–º –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.

#  –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—É: $ watch -n 10 -c --no-wrap nvidia-smi
#
# –ê–≤—Ç–æ—Ä: –ú–∏—Ö–∞–∏–ª –®–∞—Ä–¥–∏–Ω https://shardin.name/
# –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 19.08.2025
# –í–µ—Ä—Å–∏—è: 1.0
#
# –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –≤—Å–µ–≥–¥–∞ –∑–¥–µ—Å—å: https://github.com/empenoso/doorcam-face-report/
#

set -e

INPUT_VIDEO_DIR="/home/mike/–í–∏–¥–µ–æ/perm_domofon" # . –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –≤–∏–¥–µ–æ
OUTPUT_HTML_FILE="face_report_perm_domofon.html"

VENV_DIR=".venv"

echo "=== –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ ==="

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è ---
if [ ! -d "$VENV_DIR" ]; then
    echo -e "\033[1;31m[ERROR] –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ '$VENV_DIR' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏ setup_env.sh.\033[0m"
    exit 1
fi

echo "[INFO] –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
source "$VENV_DIR/bin/activate"

echo -e "\n[INFO] –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞..."

# –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –Ω–∏–∂–µ, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–≤ –Ω—É–∂–Ω—É—é —Å—Ç—Ä–æ–∫—É
#
# --- –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –¢–æ—á–Ω–∞—è –º–æ–¥–µ–ª—å CNN (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—á–∞–ª–∞) ---
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—É—é, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å CNN. –ú–∞—Å—à—Ç–∞–± –Ω–µ –º–µ–Ω—è–µ–º (1.0), —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–µ—Ç–∞–ª–∏.
# –ü—Ä–æ–ø—É—Å–∫ –∫–∞–¥—Ä–æ–≤ —É–º–µ–Ω—å—à–µ–Ω –¥–æ 15 –¥–ª—è –±–æ–ª—å—à–µ–≥–æ —à–∞–Ω—Å–∞ –ø–æ–π–º–∞—Ç—å –ª–∏—Ü–æ.
# --debug –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.
echo "[STRATEGY] –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—É—é –º–æ–¥–µ–ª—å CNN –±–µ–∑ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –æ—Ç–ª–∞–¥–∫–æ–π."
python3 face_report.py \
    --input-dir "$INPUT_VIDEO_DIR" \
    --output-html "$OUTPUT_HTML_FILE" \
    --model cnn \
    --scale 1.0 \
    --skip-frames 5 \
#    --debug

# # --- –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –ë–æ–ª–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è HOG (–µ—Å–ª–∏ CNN —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ) ---
# # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å HOG, –Ω–æ –±–µ–∑ —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–∞–¥—Ä–∞.
# echo "[STRATEGY] –ò—Å–ø–æ–ª—å–∑—É–µ–º –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å HOG –±–µ–∑ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è."
# python3 face_report.py \
#     --input-dir "$INPUT_VIDEO_DIR" \
#     --output-html "$OUTPUT_HTML_FILE" \
#     --model hog \
#     --scale 1.0 \
#     --skip-frames 15 \
#     --debug

# # --- –°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: –ò—Å—Ö–æ–¥–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è) ---
# echo "[STRATEGY] –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (hog, scale 0.5)."
# python3 face_report.py \
#     --input-dir "$INPUT_VIDEO_DIR" \
#     --output-html "$OUTPUT_HTML_FILE" \
#     --model hog \
#     --scale 0.5 \
#     --skip-frames 25 \
#     --debug

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ===
if [ -s "$OUTPUT_HTML_FILE" ]; then
    echo -e "\n\033[1;32m[SUCCESS] –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –û—Ç–∫—Ä–æ–π '$OUTPUT_HTML_FILE' –≤ –±—Ä–∞—É–∑–µ—Ä–µ.\033[0m"
else
    echo -e "\n\033[1;31m[ERROR] –§–∞–π–ª '$OUTPUT_HTML_FILE' –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω.\033[0m"
    exit 1
fi